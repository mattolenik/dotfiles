#!/usr/bin/env bash
set -euo pipefail

config_path="$HOME/.config/httpreq/sites.json"

main() {
  local auth base_url content_type site_name
  local method="$1"
  local url="$2"
  url="${url/#\//}"
  site_name="${url%%/*}"
  url="${url#*/}"


  auth="$(config ".$site_name.auth")"
  base_url="$(config ".$site_name.url")"
  content_type="$(config ".$site_name.content_type")"

  if [[ -z $base_url ]]; then
    echo "Must set url in $config_path"; exit 1
  fi
  auth="${auth:+-H \"Authorization: $auth\"}"
  content_type="${content_type:+-H \"Content-Type: $content_type\"}"
  local cmd="curl -sS -w '%{http_code}\n' -X ${method^^} $base_url/$url $auth $content_type"
  #echo "$cmd"
  eval "$cmd"
}

config() {
  jq -r "$1" "$config_path"
}

main "$@"
